"use strict";const tts_default_options={host:"https://cp.speechpro.com/vktts/rest/",voice:"Alexander",language:"Russian",numChannels:1,sampleRate:22050};class SpeechProTTS{constructor(t){this.options={host:t.host||tts_default_options.host,voice:t.voice||tts_default_options.voice,language:t.language||tts_default_options.language};let e=this;t.client&&"object"==typeof t.client&&e.createSession(t.client).then(function(t){e.session_id=t.session_id;try{e.complete(e.session_id)}catch(t){}}).catch(function(t){try{e.error(t)}catch(t){}})}ajax(t,e,s,n,o){return new Promise(function(i,a){let c=new XMLHttpRequest;if(c.open(t,e,s),"object"==typeof o)for(let t in o)c.setRequestHeader(t,o[t]);c.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)try{i(JSON.parse(this.responseText))}catch(t){a(t)}else a(this)},c.send(JSON.stringify(n))})}createSession(t){return this.ajax("POST",this.options.host+"session",!0,t,{"Content-type":"application/json;charset=UTF-8"})}checkSession(){return this.ajax("GET",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSession(){return this.ajax("DELETE",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}getLanguages(){return this.ajax("GET",this.options.host+"v1/languages",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}setLanguage(t){this.options.language=t}setVoice(t){this.options.voice=t}getVoices(t){return this.ajax("GET",this.options.host+"v1/languages/"+(t||this.options.language)+"/voices",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}getSocket(t){return this.ajax("POST",this.options.host+"v1/synthesize/stream",!0,t,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSocket(){return this.ajax("DELETE",this.options.host+"v1/synthesize/stream",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id,"X-Transaction-Id":this.transaction_id})}createSocket(t){let e=this;return new Promise(function(s,n){e.getSocket({text:{mime:"text/plain"},voice_name:t||e.options.voice,audio:"audio/wav"}).then(function(t){let n=new WebSocket(t.url);e.transaction_id=t.url.split("stream/")[1],s(n)}).catch(function(t){n(t)})})}sendSocket(t,e){let s=this;s.socket?s.socket.send(t):s.createSocket(e.voice).then(function(n){s.socket=n,s.socket.binaryType="arraybuffer",s.int16Array=new Int16Array,s.socket.onopen=function(){console.log("Socket: connection success"),s.socket.send(t)},s.socket.onclose=function(t){if(t.wasClean){console.log("Socket: connection closed cleanly");let t=s.encodeWav(s.int16Array),n=URL.createObjectURL(t);if(e.play){new Audio(n).play()}try{s.synthesizeSocketComplete({blob:t,blobUrl:n})}catch(t){}}else console.log("Socket: disconnect");console.log("Code: "+t.code+" reason: "+t.reason),s.socket=null,s.int16Array=null},s.socket.onmessage=function(t){let e=new Int16Array(t.data);s.int16Array=s.appendBuffer(s.int16Array,e);try{s.synthesizeSocketOnline(t.data)}catch(t){}},s.socket.onerror=function(t){console.log("Socket: error: "+t.message)}}).catch(function(t){console.error(t)})}getWavFromBuffer(){return this.int16Array?this.encodeWav(this.int16Array):null}synthesize(t,e){let s,n,o=this;t=t||"",e&&"object"==typeof e&&(s=e.voice,n=e.play),o.ajax("POST",o.options.host+"v1/synthesize",!0,{text:{mime:"text/plain",value:t},voice_name:s||o.options.voice,audio:"audio/wav"},{"Content-type":"application/json;charset=UTF-8","X-Session-Id":o.session_id}).then(function(t){let e=o.b64ToBlob(t.data),s=URL.createObjectURL(e);if(n){let t=new Audio;t.src=s,t.play()}try{o.synthesizeComplete({b64Data:t.data,blob:e,blobUrl:s})}catch(t){}}).catch(function(t){try{o.synthesizeError(t)}catch(t){}})}writeUTFBytes(t,e,s){let n=s.length;for(let o=0;o<n;o++)t.setUint8(e+o,s.charCodeAt(o))}appendBuffer(t,e){let s=new Int16Array(t.byteLength/2+e.byteLength/2);return s.set(new Int16Array(t),0),s.set(new Int16Array(e),t.byteLength/2),s}encodeWav(t){let e=new ArrayBuffer(44+2*t.length),s=new DataView(e);this.writeUTFBytes(s,0,"RIFF"),s.setUint32(4,44+2*t.length,!0),this.writeUTFBytes(s,8,"WAVE"),this.writeUTFBytes(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,tts_default_options.numChannels,!0),s.setUint32(24,tts_default_options.sampleRate,!0),s.setUint32(28,4*tts_default_options.sampleRate,!0),s.setUint16(32,4,!0),s.setUint16(34,16,!0),this.writeUTFBytes(s,36,"data"),s.setUint32(40,2*t.length,!0);let n=t.length,o=44;for(let e=0;e<n;e++)s.setInt16(o,1*t[e],!0),o+=2;return new Blob([s],{type:"audio/x-wav"})}b64ToBlob(t,e,s){e=e||"",s=s||512;let n=atob(t),o=[];for(let t=0;t<n.length;t+=s){let e=n.slice(t,t+s),i=new Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);let a=new Uint8Array(i);o.push(a)}return new Blob(o,{type:e})}}
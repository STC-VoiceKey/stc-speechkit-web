"use strict";const asr_default_options={host:"https://cp.speechpro.com/vkasr/rest/",package:"SpontRus-2",packageSocket:"CommonRespeakingRus-1",bufferSize:2048,bufferLength:6e4,numChannels:1,sampleRate:8e3,sampleRateSocket:16e3};class SpeechProASR{constructor(e){this.options=e||{},this.options.host=e.host||asr_default_options.host,this.options.package=e.package||asr_default_options.package,this.options.packageSocket=e.packageSocket||asr_default_options.packageSocket,this.options.bufferLength=e.bufferLength||asr_default_options.bufferLength,this.session_id=null;let t=this;t.createSession(t.options.client).then(function(e){t.options.recorder&&t.recorder(),t.session_id=e.session_id;try{t.complete(t.session_id)}catch(e){}}).catch(function(e){try{t.error(e)}catch(e){}})}ajax(e,t,o,n,s){return new Promise(function(i,a){let r=new XMLHttpRequest;if(r.open(e,t,o),"object"==typeof s)for(let e in s)r.setRequestHeader(e,s[e]);r.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)try{i(JSON.parse(this.responseText))}catch(e){a(e)}else a(this)},r.send(JSON.stringify(n))})}createSession(e){return this.ajax("POST",this.options.host+"session",!0,e,{"Content-type":"application/json;charset=UTF-8"})}checkSession(){return this.ajax("GET",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSession(){return this.ajax("DELETE",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}getPackages(){return this.ajax("GET",this.options.host+"v1/packages/available",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}setPackage(e){this.options.package=e}setPackageSocket(e){this.options.packageSocket=e}packageLoad(e){return this.ajax("GET",this.options.host+"v1/packages/"+e+"/load",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}packageUnload(e){return this.ajax("GET",this.options.host+"v1/packages/"+e+"/unload",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}recognizeFile(e){let t=this;t.packageLoad(t.options.package).then(function(){t.recognize(e)}).catch(function(e){console.error(e.responseText)})}recognize(e){let t=this,o=new FileReader;o.readAsDataURL(e),o.onloadend=function(e){t.ajax("POST",t.options.host+"v1/recognize",!0,{audio:{data:e.target.result.split(",")[1],mime:"audio/x-wav"},package_id:t.options.package},{"Content-type":"application/json;charset=UTF-8","X-Session-Id":t.session_id}).then(function(e){try{t.recognizeComplete(e)}catch(e){}}).catch(function(e){try{t.recognizeError(e)}catch(e){}}).finally(function(){t.packageUnload(t.options.package).then(function(){t.packageLoaded=null})})}}getSocket(e){return this.ajax("POST",this.options.host+"v1/recognize/stream",!0,e,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSocket(){return this.ajax("DELETE",this.options.host+"v1/recognize/stream",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id,"X-Transaction-Id":this.transaction_id})}createSocket(){let e=this;return new Promise(function(t,o){e.getSocket({package_id:e.options.packageSocket,mime:"audio/L16"}).then(function(o){let n=new WebSocket(o.url);e.transaction_id=o.url.split("stream/")[1],t(n)}).catch(function(e){o(e)})})}recorder(){let e=this;return new Promise(function(t,o){e.options.bufferSize=asr_default_options.bufferSize,e.options.numChannels=asr_default_options.numChannels,e.options.sampleRate=asr_default_options.sampleRate,e.options.sampleRateSocket=asr_default_options.sampleRateSocket,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,e.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia,e.mediaDevices=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:e.getUserMedia?{getUserMedia:function(t){return new Promise(function(o,n){e.getUserMedia.call(navigator,t,o,n)})}}:null,e.mediaDevices.getUserMedia({audio:!0}).then(function(o){let n=window.AudioContext||window.webkitAudioContext;e.context=new n,e.source=e.context.createMediaStreamSource(o),e.sampleRate=e.context.sampleRate,null==e.context.createScriptProcessor&&(e.context.createScriptProcessor=e.context.createJavaScriptNode),e.volume=e.context.createGain(),e.source.connect(e.volume),e.options.recorder=!0,t(o)}).catch(function(e){o(e)})})}startRecord(){let e=this;e.isRecording()?console.warn("startRecording: previous recording is running"):e.options.recorder?(e.packageLoad(e.options.package).then(function(){e.packageLoaded=!0}).catch(function(e){console.error(e.responseText)}),e.leftchannel=[],e.rightchannel=[],e.recordingLength=0,e.processor=e.context.createScriptProcessor(e.options.bufferSize,2,2),e.processor.onaudioprocess=function(t){let o=t.inputBuffer.getChannelData(0),n=t.inputBuffer.getChannelData(1);e.leftchannel.push(new Float32Array(o)),e.rightchannel.push(new Float32Array(n)),e.recordingLength+=e.options.bufferSize},e.volume.connect(e.processor),e.processor.connect(e.context.destination)):console.warn("startRecording: recorder is not initialized")}stopRecord(){this.isRecording()?(this.volume.disconnect(),this.processor.disconnect(),delete this.processor,this.encodeWav()):console.warn("finishRecording: no recording is running")}startSocket(){if(this.isRecording())console.warn("startRecording: previous recording is running");else{let e=this;this.createSocket().then(function(t){e.socket=t,e.socket.onopen=function(){console.log("Socket: connection success")},e.socket.onclose=function(e){e.wasClean?console.log("Socket: connection closed cleanly"):console.log("Socket: disconnect"),console.log("Code: "+e.code+" reason: "+e.reason)},e.socket.onmessage=function(t){try{e.recognizeSocketComplete(t.data)}catch(e){}},e.socket.onerror=function(e){console.log("Socket: error: "+e.message)};let o=[],n=[],s=0;e.processor=e.context.createScriptProcessor(e.options.bufferSize,2,2),e.processor.onaudioprocess=function(t){let i=t.inputBuffer.getChannelData(0),a=t.inputBuffer.getChannelData(1);o.push(new Float32Array(i)),n.push(new Float32Array(a)),s+=e.options.bufferSize,e.lastRecording={left:o,right:n,length:s},s>e.options.bufferLength&&(e.sendSocket(o,n,s),o=[],n=[],s=0,e.lastRecording=null)},e.volume.connect(e.processor),e.processor.connect(e.context.destination)}).catch(function(e){console.error("Socket: create socket fail: "+e.responseText)})}}sendSocket(e,t,o){let n=this.mergeBuffers(e,o),s=this.mergeBuffers(t,o);n=this.downSampleBuffer(n,this.options.sampleRateSocket),s=this.downSampleBuffer(s,this.options.sampleRateSocket);let i=this.options.numChannels>1?this.interleave(n,s):n,a=new ArrayBuffer(44+2*i.length),r=new DataView(a),c=44;for(let e=0;e<i.length;e++)r.setInt16(c,32767*i[e],!0),c+=2;this.socket.send(new Blob([r],{type:"audio/L16"}))}startRecordSocket(){let e=this;e.options.recorder?e.startSocket():this.recorder().then(function(){e.startSocket()}).catch(function(e){console.error(e)})}stopRecordSocket(){let e=this;e.isRecording()||!e.options.recorder?(e.sendSocket(e.lastRecording.left,e.lastRecording.right,e.lastRecording.length),e.volume.disconnect(),e.processor.disconnect(),delete e.processor,e.closeSocket().then(function(t){try{e.recognizeSocketCompleteFinal(t)}catch(e){}}).catch(function(){e.socket.close()})):console.warn("finishRecording: no recording is running")}isRecording(){return null!=this.processor}mergeBuffers(e,t){let o=new Float32Array(t),n=0,s=e.length;for(let t=0;t<s;t++){let s=e[t];o.set(s,n),n+=s.length}return o}interleave(e,t){let o=e.length+t.length,n=new Float32Array(o),s=0;for(let i=0;i<o;)n[i++]=e[s],n[i++]=t[s],s++;return n}writeUTFBytes(e,t,o){let n=o.length;for(let s=0;s<n;s++)e.setUint8(t+s,o.charCodeAt(s))}downSampleBuffer(e,t){if(t==this.sampleRate)return e;t>this.sampleRate&&console.warn("downsampling rate show be smaller than original sample rate");let o=this.sampleRate/t,n=Math.round(e.length/o),s=new Float32Array(n),i=0,a=0;for(;i<s.length;){let t=Math.round((i+1)*o),n=0,r=0;for(let o=a;o<t&&o<e.length;o++)n+=e[o],r++;s[i]=n/r,i++,a=t}return s}encodeWav(){let e=this.mergeBuffers(this.leftchannel,this.recordingLength),t=this.mergeBuffers(this.rightchannel,this.recordingLength);e=this.downSampleBuffer(e,this.options.sampleRate),t=this.downSampleBuffer(t,this.options.sampleRate);let o=this.options.numChannels>1?this.interleave(e,t):e,n=new ArrayBuffer(44+2*o.length),s=new DataView(n);this.writeUTFBytes(s,0,"RIFF"),s.setUint32(4,44+2*o.length,!0),this.writeUTFBytes(s,8,"WAVE"),this.writeUTFBytes(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,this.options.numChannels,!0),s.setUint32(24,this.options.sampleRate,!0),s.setUint32(28,4*this.options.sampleRate,!0),s.setUint16(32,4,!0),s.setUint16(34,16,!0),this.writeUTFBytes(s,36,"data"),s.setUint32(40,2*o.length,!0);let i=o.length,a=44;for(let e=0;e<i;e++)s.setInt16(a,32767*o[e],!0),a+=2;let r=this,c=function(){r.packageLoaded?r.recognize(new Blob([s],{type:"audio/x-wav"})):requestAnimationFrame(c)};requestAnimationFrame(c)}}
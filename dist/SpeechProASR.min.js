'use strict';const asr_default_options={host:"https://cp.speechpro.com/vkasr/rest/",package:"FarField",packageSocket:"FarField",bufferSize:2048,bufferLength:6e4,numChannels:1,sampleRate:16e3,sampleRateSocket:16e3};class SpeechProASR{constructor(a){this.options={host:a.host||asr_default_options.host,package:a.package||asr_default_options.package,packageSocket:a.packageSocket||asr_default_options.packageSocket,bufferLength:a.bufferLength||asr_default_options.bufferLength,recorder:a.recorder||!1},this.session_id=null;let b=this;a.client&&"object"==typeof a.client&&b.createSession(a.client).then(function(a){b.options.recorder&&b.recorder(),b.session_id=a.session_id;try{b.complete(b.session_id)}catch(a){}}).catch(function(a){try{b.error(a)}catch(a){}})}ajax(a,b,c,d,e){return new Promise(function(f,g){let h=new XMLHttpRequest;if(h.open(a,b,c),"object"==typeof e)for(let a in e)h.setRequestHeader(a,e[a]);h.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)try{f(JSON.parse(this.responseText))}catch(a){g(a)}else g(this)},h.send(JSON.stringify(d))})}createSession(a){return this.ajax("POST","https://cp.speechpro.com/vksession/rest/session",!0,a,{"Content-type":"application/json;charset=UTF-8"})}checkSession(){return this.ajax("GET",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSession(){return this.ajax("DELETE",this.options.host+"session",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}getPackages(){return this.ajax("GET",this.options.host+"v1/packages/available",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}setPackage(a){this.options.package=a}setPackageSocket(a){this.options.packageSocket=a}packageLoad(a){return this.ajax("GET",this.options.host+"v1/packages/"+a+"/load",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}recognizeFile(a){let b=this;b.packageLoad(b.options.package).then(function(){b.recognize(a)}).catch(function(a){console.error(a.responseText)})}recognize(a){let b=this,c=new FileReader;c.readAsDataURL(a),c.onloadend=function(a){b.ajax("POST",b.options.host+"v1/recognize",!0,{audio:{data:a.target.result.split(",")[1],mime:"audio/x-wav"},package_id:b.options.package},{"Content-type":"application/json;charset=UTF-8","X-Session-Id":b.session_id}).then(function(a){try{b.recognizeComplete(a)}catch(a){}}).catch(function(a){try{b.recognizeError(a)}catch(a){}}).finally(function(){b.packageLoaded=null})}}getSocket(a){return this.ajax("POST",this.options.host+"v1/recognize/stream",!0,a,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id})}closeSocket(){return this.ajax("DELETE",this.options.host+"v1/recognize/stream",!0,null,{"Content-type":"application/json;charset=UTF-8","X-Session-Id":this.session_id,"X-Transaction-Id":this.transaction_id})}createSocket(){let a=this;return new Promise(function(b,c){a.getSocket({package_id:a.options.packageSocket,mime:"audio/l16"}).then(function(c){let d=new WebSocket(c.url);a.transaction_id=c.url.split("stream/")[1],b(d)}).catch(function(a){c(a)})})}recorder(){let a=this;return new Promise(function(b,c){a.options.bufferSize=asr_default_options.bufferSize,a.options.numChannels=asr_default_options.numChannels,a.options.sampleRate=asr_default_options.sampleRate,a.options.sampleRateSocket=asr_default_options.sampleRateSocket,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,a.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia,a.mediaDevices=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:a.getUserMedia?{getUserMedia:function(b){return new Promise(function(c,d){a.getUserMedia.call(navigator,b,c,d)})}}:null,a.mediaDevices.getUserMedia({audio:!0}).then(function(c){let d=window.AudioContext||window.webkitAudioContext;a.context=new d,a.source=a.context.createMediaStreamSource(c),a.sampleRate=a.context.sampleRate,null==a.context.createScriptProcessor&&(a.context.createScriptProcessor=a.context.createJavaScriptNode),a.volume=a.context.createGain(),a.source.connect(a.volume),a.options.recorder=!0,b(c)}).catch(function(a){c(a)})})}startSocket(){let a=this;this.createSocket().then(function(b){a.socket=b,a.socket.onopen=function(){console.log("Socket: connection success");let b=[],c=[],d=0;a.processor=a.context.createScriptProcessor(a.options.bufferSize,2,2),a.processor.onaudioprocess=function(f){let e=f.inputBuffer.getChannelData(0),g=f.inputBuffer.getChannelData(1);b.push(new Float32Array(e)),c.push(new Float32Array(g)),d+=a.options.bufferSize,a.lastRecording={left:b,right:c,length:d},d>a.options.bufferLength&&(a.sendSocket(b,c,d),b=[],c=[],d=0,a.lastRecording=null)},a.volume.connect(a.processor),a.processor.connect(a.context.destination)},a.socket.onclose=function(b){a.recSocket=null,b.wasClean?console.log("Socket: connection closed cleanly"):console.log("Socket: disconnect"),console.log("Code: "+b.code+" reason: "+b.reason)},a.socket.onmessage=function(b){try{a.recognizeSocketComplete(b.data)}catch(a){}},a.socket.onerror=function(b){a.recSocket=null,console.log("Socket: error: "+b.message)}}).catch(function(b){a.recSocket=null,console.error("Socket: create socket fail: "+b.responseText)})}sendSocket(a,b,c){let d=this,e=this.mergeBuffers(a,c),f=this.mergeBuffers(b,c);e=this.downSampleBuffer(e,this.options.sampleRateSocket),f=this.downSampleBuffer(f,this.options.sampleRateSocket);let g=1<this.options.numChannels?this.interleave(e,f):e,h=new ArrayBuffer(44+2*g.length),j=new DataView(h),k=44;for(let d=0;d<g.length;d++)j.setInt16(k,32767*g[d],!0),k+=2;let l=function(){d.packageSocketLoaded?d.socket.send(new Blob([j],{type:"audio/l16"})):requestAnimationFrame(l)};requestAnimationFrame(l)}startRecord(){let a=this;a.isRecording()?console.info("startRecording: previous recording is running"):a.options.recorder?(a.packageLoad(a.options.package).then(function(){a.packageLoaded=!0}).catch(function(a){console.error(a.responseText)}),a.leftchannel=[],a.rightchannel=[],a.recordingLength=0,a.processor=a.context.createScriptProcessor(a.options.bufferSize,2,2),a.processor.onaudioprocess=function(b){let c=b.inputBuffer.getChannelData(0),d=b.inputBuffer.getChannelData(1);a.leftchannel.push(new Float32Array(c)),a.rightchannel.push(new Float32Array(d)),a.recordingLength+=a.options.bufferSize},a.volume.connect(a.processor),a.processor.connect(a.context.destination)):console.info("startRecording: recorder is not initialized")}stopRecord(){this.isRecording()&&!this.recSocket?(this.volume.disconnect(),this.processor.disconnect(),delete this.processor,this.encodeWav()):console.info("finishRecording: no recording is running")}startRecordSocket(){let a=this;a.isRecording()||a.recSocket?console.info("startRecordingSocket: previous recording is running"):(a.recSocket=!0,a.packageLoad(a.options.packageSocket).then(function(){a.packageSocketLoaded=!0}).catch(function(a){console.error(a.responseText)}),a.options.recorder?a.startSocket():this.recorder().then(function(){a.startSocket()}).catch(function(a){console.error(a)}))}stopRecordSocket(){let a=this;a.isRecording()&&a.recSocket?(a.recSocket=null,a.sendSocket(a.lastRecording.left,a.lastRecording.right,a.lastRecording.length),a.volume.disconnect(),a.processor.disconnect(),delete a.processor,a.closeSocket().then(function(b){try{a.recognizeSocketCompleteFinal(b)}catch(a){}}).catch(function(){a.socket.close()}).finally(function(){a.packageSocketLoaded=null})):console.info("finishRecordingSocket: no recording is running")}isRecording(){return null!=this.processor}mergeBuffers(a,b){let c=new Float32Array(b),d=0,e=a.length;for(let f,g=0;g<e;g++)f=a[g],c.set(f,d),d+=f.length;return c}interleave(a,b){let c=a.length+b.length,d=new Float32Array(c),e=0;for(let f=0;f<c;)d[f++]=a[e],d[f++]=b[e],e++;return d}writeUTFBytes(a,b,c){let d=c.length;for(let e=0;e<d;e++)a.setUint8(b+e,c.charCodeAt(e))}downSampleBuffer(a,b){var c=Math.round;if(b==this.sampleRate)return a;b>this.sampleRate&&console.info("downsampling rate show be smaller than original sample rate");let d=this.sampleRate/b,e=c(a.length/d),f=new Float32Array(e),g=0,h=0;for(;g<f.length;){let b=c((g+1)*d),e=0,j=0;for(let c=h;c<b&&c<a.length;c++)e+=a[c],j++;f[g]=e/j,g++,h=b}return f}encodeWav(){let a=this.mergeBuffers(this.leftchannel,this.recordingLength),b=this.mergeBuffers(this.rightchannel,this.recordingLength);a=this.downSampleBuffer(a,this.options.sampleRate),b=this.downSampleBuffer(b,this.options.sampleRate);let c=1<this.options.numChannels?this.interleave(a,b):a,d=new ArrayBuffer(44+2*c.length),e=new DataView(d);this.writeUTFBytes(e,0,"RIFF"),e.setUint32(4,44+2*c.length,!0),this.writeUTFBytes(e,8,"WAVE"),this.writeUTFBytes(e,12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,this.options.numChannels,!0),e.setUint32(24,this.options.sampleRate,!0),e.setUint32(28,4*this.options.sampleRate,!0),e.setUint16(32,4,!0),e.setUint16(34,16,!0),this.writeUTFBytes(e,36,"data"),e.setUint32(40,2*c.length,!0);let f=c.length,g=44;for(let a=0;a<f;a++)e.setInt16(g,32767*c[a],!0),g+=2;let h=this,i=function(){h.packageLoaded?h.recognize(new Blob([e],{type:"audio/x-wav"})):requestAnimationFrame(i)};requestAnimationFrame(i)}}